<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>暗記モード - 結果</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container">
    <header class="site-header card">
      <div class="header-left">
        <h1>テスト結果</h1>
        <p class="subtitle">今回の成績を表示します</p>
      </div>
      <nav style="display:flex;gap:12px;align-items:center;margin-left:auto">
        <button id="openMemorizeBtn" class="btn">暗記に戻る</button>
        <a href="index.html" class="btn">点数記録</a>
        <a href="timer.html" class="btn">タイマー</a>
      </nav>
    </header>

    <section class="card" id="resultArea" style="text-align:center">
      <h3>結果</h3>
      <div style="font-size:1.2rem">正答率: <strong id="percent">-</strong>% （前回: <span id="prev">-</span>）</div>
      <div style="display:flex;gap:18px;align-items:flex-start;justify-content:center;margin-top:18px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px;max-width:640px;text-align:left">
          <div style="font-size:0.95rem;color:var(--muted);margin-bottom:6px">履歴（折れ線グラフ）</div>
          <canvas id="lineChart" width="640" height="260" style="width:100%;height:auto;border:1px solid rgba(255,102,170,0.2);background:rgba(40,40,60,0.6);border-radius:8px"></canvas>
        </div>
        <div style="width:320px;text-align:center">
          <div style="font-size:0.95rem;color:var(--muted);margin-bottom:6px">今回の内訳</div>
          <canvas id="resultChart" width="300" height="300" style="background:rgba(40,40,60,0.6);border:1px solid rgba(255,102,170,0.2);border-radius:8px"></canvas>
        </div>
      </div>
      <div id="extra" style="margin-top:12px;color:var(--muted)"></div>
    </section>
  </main>

  <script>
  (function(){
    const pctEl = document.getElementById('percent');
    const prevEl = document.getElementById('prev');
    const extra = document.getElementById('extra');
    const lineCanvas = document.getElementById('lineChart');
    const pieCanvas = document.getElementById('resultChart');
    try{
      function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      // get deck id from query or sessionStorage
      const params = new URLSearchParams(window.location.search);
      let deckId = params.get('deck');
      const raw = sessionStorage.getItem('kiroku_lot_last_result');
      if(!raw && !deckId){ extra.textContent = '結果データが見つかりません。'; return; }
      const obj = raw ? JSON.parse(raw) : null;
      if(!deckId && obj) deckId = obj.deckId;
      const pct = obj && (typeof obj.pct === 'number') ? obj.pct : 0;
      const prev = obj && (typeof obj.prev === 'number') ? obj.prev.toFixed(2) + '%' : '-';
      pctEl.textContent = (pct||0).toFixed(2);
      prevEl.textContent = prev;

      // draw pie
      const correct = obj ? (obj.correct||0) : 0; const incorrect = obj ? (obj.incorrect||0) : 0;
      const c = pieCanvas.getContext('2d'); const cx = pieCanvas.width/2; const cy = pieCanvas.height/2; const r = Math.min(cx,cy)-12;
      const total = (correct + incorrect) || 1; const angle = (correct/total) * Math.PI * 2;
      c.clearRect(0,0,pieCanvas.width,pieCanvas.height);
      c.beginPath(); c.moveTo(cx,cy); c.fillStyle = '#ef4444'; c.arc(cx,cy,r,-Math.PI/2, -Math.PI/2 + angle); c.closePath(); c.fill();
      c.beginPath(); c.moveTo(cx,cy); c.fillStyle = '#3b82f6'; c.arc(cx,cy,r,-Math.PI/2 + angle, -Math.PI/2 + Math.PI*2); c.closePath(); c.fill();
      extra.textContent = `正答 ${correct} / ${correct+incorrect}`;

      // draw line chart from history
      try{
        const HIST_KEY = 'kiroku_lot_cards_results_history_v1';
        const rawHist = localStorage.getItem(HIST_KEY);
        const histObj = rawHist ? JSON.parse(rawHist) : {};
        const series = histObj[deckId] || [];
        const lc = lineCanvas.getContext('2d'); const lw = lineCanvas.width; const lh = lineCanvas.height;
        lc.clearRect(0,0,lw,lh);
        if(!series.length){ lc.fillStyle = 'var(--muted)'; lc.font = '14px sans-serif'; lc.fillText('履歴がありません', 12, 24); }
        else{
          // normalize times and values
          const points = series.map(s=>({t:s.t, v: s.pct}));
          const tmin = points[0].t; const tmax = points[points.length-1].t;
          // values are percentages; fix scale to 0-100 for stable plotting
          const vmin = 0; const vmax = 100;
          const pad = 24; const gx0 = pad; const gy0 = lh - pad; const gw = lw - pad*2; const gh = lh - pad*2;
          // axes
          lc.strokeStyle = '#e6eef8'; lc.lineWidth = 1; lc.beginPath(); lc.moveTo(gx0, pad); lc.lineTo(gx0, gy0); lc.lineTo(gx0+gw, gy0); lc.stroke();
          // plot
          lc.strokeStyle = '#3b82f6'; lc.lineWidth = 2; lc.beginPath();
          points.forEach((p,i)=>{
            const x = gx0 + ( (p.t - tmin) / Math.max(1, tmax - tmin) ) * gw;
            const y = gy0 - ( (p.v - vmin) / Math.max(0.0001, vmax - vmin) ) * gh;
            if(i===0) lc.moveTo(x,y); else lc.lineTo(x,y);
          }); lc.stroke();
          // dots
          lc.fillStyle = '#ef4444'; points.forEach((p)=>{ const x = gx0 + ((p.t - tmin) / Math.max(1, tmax - tmin)) * gw; const y = gy0 - ((p.v - vmin) / Math.max(0.0001, vmax - vmin || 100)) * gh; lc.beginPath(); lc.arc(x,y,3,0,Math.PI*2); lc.fill(); });
        }
      }catch(e){ console.warn('draw history failed', e); }
      // show per-card breakdown if provided
      try{
        const entries = obj && obj.entries ? obj.entries : [];
        if(entries && entries.length){
          const list = document.createElement('div'); list.style.textAlign='left'; list.style.marginTop='16px';
          list.innerHTML = '<h4 style="margin:8px 0 6px">カード別結果</h4>';
          const ul = document.createElement('div'); ul.style.display='flex'; ul.style.flexDirection='column'; ul.style.gap='8px';
          entries.forEach((e,i)=>{
            const row = document.createElement('div'); row.style.padding='8px'; row.style.border='1px solid rgba(255,102,170,0.2)'; row.style.borderRadius='6px'; row.style.background='rgba(40,40,60,0.6)';
            const ok = e.correct ? '✅' : '❌';
            const title = document.createElement('div'); title.style.fontWeight='600'; title.style.color='#fff'; title.textContent = `${i+1}. ${ok} ${e.front}`;
            const details = document.createElement('div'); details.style.fontSize='0.95rem'; details.style.color='var(--muted)';
            const exp = Array.isArray(e.expected) ? e.expected.join(' | ') : (e.expected||'');
            const ent = Array.isArray(e.entered) ? e.entered.join(' | ') : (e.entered||'');
            details.innerHTML = `<div>期待: ${escapeHtml(exp)}</div><div>解答: ${escapeHtml(ent)}</div>`;
            row.appendChild(title); row.appendChild(details); ul.appendChild(row);
          });
          list.appendChild(ul);
          extra.appendChild(list);
        }
      }catch(e){ console.warn('render entries failed', e); }
      // update open-memorize button to include deck id and edit flag
      const openBtn = document.getElementById('openMemorizeBtn'); if(openBtn){ openBtn.addEventListener('click', ()=>{
        try{ sessionStorage.setItem('kiroku_lot_open_edit', deckId || ''); }catch(e){}
        window.location.href = 'memorization.html?edit=1' + (deckId ? '&deck=' + encodeURIComponent(deckId) : '');
      }); }
    }catch(e){ extra.textContent = '結果の読み込みに失敗しました'; console.warn(e); }
  })();
  </script>
</body>
</html>
